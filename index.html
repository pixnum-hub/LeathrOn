<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LeathrOn - Leather Costing Calculator</title>
<style>
*{box-sizing:border-box;}
body{margin:0;font-family:Arial,sans-serif;background:#e0e0e0;transition:0.3s;}
.dark{background:#1c1c1c;color:#fff;}
.app{position:relative;width:95%;max-width:1000px;margin:20px auto;padding:25px;border-radius:30px;background:#e6e6e6;box-shadow:9px 9px 18px #b8b8b8,-9px -9px 18px #ffffff;}
.dark .app{background:#2a2a2a;box-shadow:9px 9px 18px #161616,-9px -9px 18px #3a3a3a;}
input,select,textarea{width:100%;padding:12px;margin:8px 0;border:none;border-radius:15px;background:#f2f2f2;box-shadow:inset 5px 5px 10px #bcbcbc,inset -5px -5px 10px #ffffff;outline:none;}
input[type=number]{-moz-appearance:textfield;}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.dark input,.dark select,.dark textarea{background:#333;color:#fff;box-shadow:inset 5px 5px 10px #141414,inset -5px -5px 10px #474747;}
button{padding:14px 18px;border:none;border-radius:20px;margin:10px 0;background:#e6e6e6;box-shadow:6px 6px 12px #b8b8b8,-6px -6px 12px #ffffff;cursor:pointer;font-size:16px;width:100%;}
.dark button{background:#333;color:#fff;box-shadow:6px 6px 12px #141414,-6px -6px 12px #474747;}
.prodCard{padding:15px;border-radius:20px;background:#f3f3f3;margin:10px 0;box-shadow:inset 3px 3px 7px #bcbcbc,inset -3px -3px 7px #ffffff;}
.dark .prodCard{background:#333;box-shadow:inset 3px 3px 7px #141414,inset -3px -3px 7px #474747;}
.prodTitle{font-size:18px;font-weight:bold;margin:5px 0;}
.popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;color:#000;padding:25px;border-radius:22px;z-index:999999;width:90%;max-width:450px;max-height:85vh;overflow:auto;box-shadow:0 0 30px #0004;}
.dark .popup{background:#2e2e2e;color:#fff;}
footer{position:fixed;bottom:0;left:0;width:100%;text-align:center;padding:12px 0;font-size:14px;z-index:999;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:0.3s;background:rgba(224,224,224,0.65);color:#000;box-shadow:0 -3px 12px rgba(0,0,0,0.15),inset -3px -3px 8px rgba(255,255,255,0.7),inset 3px 3px 8px rgba(0,0,0,0.1);}
.dark footer{background:rgba(30,30,30,0.55);color:#fff;box-shadow:0 -3px 12px rgba(0,0,0,0.45),inset -3px -3px 8px rgba(80,80,80,0.2),inset 3px 3px 8px rgba(0,0,0,0.6);}
.toggleDark{position:absolute;top:15px;right:15px;width:50px;height:50px;border-radius:50%;background:#e6e6e6;cursor:grab;box-shadow:6px 6px 12px #b8b8b8,-6px -6px 12px #ffffff;display:flex;justify-content:center;align-items:center;font-size:22px;z-index:9999;transition:0.2s;}
.dark .toggleDark{background:#333;box-shadow:6px 6px 12px #141414,-6px -6px 12px #474747;}
.toggleDark:active{cursor:grabbing;transform:scale(1.1);}
.hidden{display:none;}
</style>
</head>
<body>

<div class="container app" id="mainContainer">
  <div class="toggleDark" id="darkToggle"><span id="darkIcon">üåô</span></div>

  <h2>LeathrOn</h2>
  <div id="subscriptionUI"></div>

  <div id="mainApp" class="hidden">
    <button onclick="openProductPopup()">‚ûï Add Product</button>
    <button onclick="resetAll()">üóë Reset All</button>
    <input id="searchProd" placeholder="Search Products" oninput="filterProducts()">
    <div id="productList"></div>

    <h3>GST %</h3><input id="gst" type="number" value="18" min="0">
    <h3>Profit %</h3><input id="profit" type="number" value="20" min="0">
    <select id="currency">
      <option value="INR">INR ‚Çπ</option>
      <option value="USD">USD $</option>
    </select>

    <button onclick="calculateFinal()">Calculate Grand Total</button>
    <h2 id="grandTotal"></h2>

    <button onclick="exportTXT()">Export TXT</button>
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="generatePDFMenu()">Export PDF</button>
    <button onclick="showInvoiceHistory()">Invoice History</button>
  </div>
</div>

<footer>¬© <span id="year"></span> Manik Roy. All Right Reserved.</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.getElementById("year").textContent = new Date().getFullYear();

// DEVICE LOCK
const deviceKey="dev-"+btoa(navigator.userAgent+screen.width+screen.height);
if(localStorage.lc_device && localStorage.lc_device!==deviceKey){alert("Locked to another device.");document.body.innerHTML="DEVICE LOCKED";throw "";}else localStorage.lc_device=deviceKey;

// TRIAL & SUBSCRIPTION
if(!localStorage.lc_start){localStorage.lc_start=Date.now();}
let subscribed = localStorage.lc_sub=="yes";
function renderSub(){
  let rem=Math.floor((30*86400000-(Date.now()-localStorage.lc_start))/86400000);
  const box=document.getElementById("subscriptionUI");
  if(subscribed){document.getElementById("mainApp").classList.remove("hidden");box.innerHTML="Subscription Active ‚úì";return;}
  if(Date.now()-localStorage.lc_start<30*86400000){
    box.innerHTML=`Trial: ${rem} days left<br><button onclick="pay()">Buy ‚Çπ299/month</button>`;
    document.getElementById("mainApp").classList.remove("hidden");
  } else{
    box.innerHTML=`Trial expired<br><button onclick="pay()">Buy ‚Çπ299/month</button><br><input id="adm" placeholder='Admin Code'><button onclick="admUnlock()">Unlock</button>`;
  }
}
function pay(){let upi="upi://pay?pa=9433082017@ybl&pn=Manik%20Roy&am=299&cu=INR";let qr="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data="+encodeURIComponent(upi);pop(`<h3>Pay ‚Çπ299</h3><img src="${qr}" style="width:200px;"><br>UPI: 9433082017@ybl<button onclick='activateSub()'>I Paid</button>`);}
function activateSub(){localStorage.lc_sub="yes";subscribed=true;saveInv("‚Çπ299 Subscription",299);closePop();renderSub();}
function admUnlock(){if(document.getElementById("adm").value=="MR-LX9Q-72KF-P8W3"){localStorage.lc_sub="yes";subscribed=true;saveInv("Admin Unlock",0);renderSub();}else alert("Invalid Code");}
renderSub();

// POPUP
let popbox=null;
function pop(html){if(popbox)popbox.remove();let d=document.createElement("div");d.className="popup";d.innerHTML=html+`<br><button onclick="closePop()">Close</button>`;document.body.appendChild(d);popbox=d;}
function closePop(){if(popbox)popbox.remove();}

// PRODUCTS
let products=JSON.parse(localStorage.getItem("lc_products")||"[]");
let filteredProducts=[];
function saveProductsToStorage(){localStorage.setItem("lc_products",JSON.stringify(products));}

function openProductPopup(){
  let html=`<h3>Add Product</h3>
<label>Product Type</label><select id='p_type'><option>Bag</option><option>Wallet</option><option>Belt</option><option>Shoe</option><option>Other</option></select>
<label>Material</label><select id='p_material'><option>Full-Grain</option><option>Top-Grain</option><option>Bonded</option></select>
<label>Grade</label><input id='p_grade'>
<label>Thickness (mm)</label><input id='p_thick' type='number' min='0'>
<label>Leather Area (sq.ft)</label><input id='p_area' type='number' min='0'>
<label>Leather Rate</label><input id='p_rate' type='number' min='0'>
<label>Quantity</label><input id='p_qty' type='number' value='1' min='1'>
<label>Extra Expenses</label><input id='p_extra' type='number' min='0'>
<label>Notes</label><textarea id='p_note'></textarea>
<label>Product Image</label><input id='p_img' type='file' accept='image/*'>
<img id='imgPrev' style='width:100%;border-radius:15px;display:none;margin-top:10px;'>
<button id='saveProdBtn'>Save Product</button>`;
  pop(html);

  const imgPrev = document.getElementById("imgPrev");
  document.getElementById("p_img").addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => { imgPrev.src = reader.result; imgPrev.style.display = "block"; };
    reader.readAsDataURL(file);
  });

  document.getElementById("saveProdBtn").addEventListener("click", saveProduct);
}

function saveProduct(){
  const imgPrev = document.getElementById("imgPrev");
  const product = {
    type: val("p_type"),
    material: val("p_material"),
    grade: val("p_grade"),
    thick: num("p_thick"),
    area: num("p_area"),
    rate: num("p_rate"),
    qty: num("p_qty"),
    extra: num("p_extra"),
    note: val("p_note"),
    img: imgPrev.src || ""
  };
  product.total = (product.area * product.rate + product.extra) * product.qty;
  products.push(product);
  saveProductsToStorage();
  closePop();
  renderProducts();
}

function val(id){return document.getElementById(id).value;}
function num(id){return Number(val(id))||0;}
function renderProducts(){filteredProducts=products.slice();updateProductList();}
function updateProductList(){let box=document.getElementById("productList");box.innerHTML="";filteredProducts.forEach((p,i)=>{box.innerHTML+=`<div class='prodCard'><div class='prodTitle'>${p.type} (${p.material}) x${p.qty}</div>Area: ${p.area} sq.ft | Rate: ${p.rate}<br>Total: ‚Çπ${p.total.toFixed(2)}<br><button onclick="delProd(${i})">Delete</button> <button onclick="cloneProd(${i})">Duplicate</button></div>`;});}
function delProd(i){products.splice(i,1);saveProductsToStorage();renderProducts();}
function cloneProd(i){products.push(JSON.parse(JSON.stringify(products[i])));saveProductsToStorage();renderProducts();}
function filterProducts(){const q=document.getElementById("searchProd").value.toLowerCase();filteredProducts=products.filter(p=>p.type.toLowerCase().includes(q)||p.material.toLowerCase().includes(q));updateProductList();}
function resetAll(){if(confirm("Clear all products and inputs?")){products=[];saveProductsToStorage();renderProducts();document.getElementById("grandTotal").innerHTML="";document.getElementById("gst").value=18;document.getElementById("profit").value=20;document.getElementById("currency").value="INR";document.getElementById("searchProd").value="";}}

// DARK MODE TOGGLE
const darkToggle = document.getElementById("darkToggle");
let dragging = false, offsetX = 0, offsetY = 0, clickStartX = 0, clickStartY = 0, dragThreshold = 5;

// Restore position from localStorage
if(localStorage.lc_togglePos){
  const pos = JSON.parse(localStorage.lc_togglePos);
  darkToggle.style.left = pos.x + "px";
  darkToggle.style.top = pos.y + "px";
}

darkToggle.addEventListener("mousedown", startDrag);
darkToggle.addEventListener("touchstart", startDrag, {passive:false});

function startDrag(e){
  e.preventDefault();
  const rect = darkToggle.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  offsetX = clientX - rect.left;
  offsetY = clientY - rect.top;
  clickStartX = clientX;
  clickStartY = clientY;
  dragging = false;
  document.addEventListener("mousemove", dragToggle);
  document.addEventListener("mouseup", endDrag);
  document.addEventListener("touchmove", dragToggle, {passive:false});
  document.addEventListener("touchend", endDrag);
}

function dragToggle(e){
  e.preventDefault();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  if(Math.abs(clientX-clickStartX) > dragThreshold || Math.abs(clientY-clickStartY) > dragThreshold){
    dragging = true;
  }
  let x = clientX - offsetX;
  let y = clientY - offsetY;
  x = Math.max(0, Math.min(window.innerWidth - darkToggle.offsetWidth, x));
  y = Math.max(0, Math.min(window.innerHeight - darkToggle.offsetHeight, y));
  darkToggle.style.left = x + "px";
  darkToggle.style.top = y + "px";
}

function endDrag(e){
  document.removeEventListener("mousemove", dragToggle);
  document.removeEventListener("mouseup", endDrag);
  document.removeEventListener("touchmove", dragToggle);
  document.removeEventListener("touchend", endDrag);
  localStorage.lc_togglePos = JSON.stringify({x: darkToggle.offsetLeft, y: darkToggle.offsetTop});
  if(!dragging) toggleDarkMode();
}

function toggleDarkMode(){
  document.body.classList.toggle("dark");
  document.getElementById("darkIcon").textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.lc_dark = document.body.classList.contains("dark") ? "yes" : "no";
}

// Load dark mode state
if(localStorage.lc_dark=="yes"){
  document.body.classList.add("dark");
  document.getElementById("darkIcon").textContent = "‚òÄÔ∏è";
}

// INITIAL RENDER
renderProducts();
</script>

</body>
</html>
