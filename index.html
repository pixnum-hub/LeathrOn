<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeatherOn ‚Äì International Costing Calculator</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e0e0e0">

<style>
/* ================= GLOBAL MOBILE-FIRST STYLING ================= */
html, body { margin:0; padding:0; font-family:Arial,sans-serif; font-size:18px; background:#e0e0e0; transition:0.3s; }
.dark { background:#1c1c1c; color:#fff; }

/* ================= APP CONTAINER ================= */
.app { position:relative; width:95%; max-width:720px; margin:20px auto; padding:20px; border-radius:25px; background:#e6e6e6; box-shadow:8px 8px 16px #b8b8b8, -8px -8px 16px #ffffff; }
.dark .app { background:#2a2a2a; box-shadow:8px 8px 16px #161616, -8px -8px 16px #3a3a3a; }

/* ================= APP HEADER & DARK TOGGLE ================= */
.appHeader{ position:absolute; top:14px; right:14px; z-index:20; }
.toggleDark{ width:52px; height:52px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; background:#e6e6e6; box-shadow:6px 6px 12px #b8b8b8, -6px -6px 12px #ffffff; transition:0.25s ease; }
.toggleDark:active{ transform:scale(0.95); }
.dark .toggleDark{ background:#2f2f2f; box-shadow:6px 6px 12px #141414, -6px -6px 12px #474747; }

/* ================= INPUTS ================= */
input, select, textarea { width:100%; padding:14px; font-size:18px; border:none; margin:8px 0; border-radius:15px; background:#f2f2f2; box-shadow:inset 4px 4px 8px #bcbcbc, inset -4px -4px 8px #ffffff; outline:none; }
.dark input, .dark select, .dark textarea { background:#333; color:#fff; box-shadow:inset 4px 4px 8px #141414, inset -4px -4px 8px #474747; }

/* ================= BUTTONS ================= */
button { padding:16px; border:none; border-radius:18px; margin:10px 0; width:100%; font-size:18px; cursor:pointer; background:#e6e6e6; box-shadow:6px 6px 12px #b8b8b8, -6px -6px 12px #ffffff; }
.dark button { background:#333; color:#fff; box-shadow:6px 6px 12px #141414, -6px -6px 12px #474747; }

/* ================= PRODUCT CARDS ================= */
.prodCard { padding:15px; border-radius:18px; background:#f3f3f3; margin:12px 0; font-size:18px; box-shadow:inset 3px 3px 7px #bcbcbc, inset -3px -3px 7px #ffffff; }
.dark .prodCard { background:#333; box-shadow:inset 3px 3px 7px #141414, inset -3px -3px 7px #474747; }
.prodTitle { font-size:20px; font-weight:bold; margin-bottom:8px; }

/* ================= POPUP ================= */
.popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:90vw; max-width:500px; max-height:85vh; overflow-y:auto; background:#fff; color:#000; padding:20px; border-radius:20px; box-shadow:0 0 30px #0005; z-index:999999; }
.dark .popup{ background:#2e2e2e; color:#fff; }

/* ================= FOOTER ================= */
footer{ position:fixed; bottom:0; left:0; width:100%; padding:14px 0; text-align:center; background:rgba(224,224,224,0.7); font-size:16px; backdrop-filter:blur(10px); box-shadow:0 -3px 12px rgba(0,0,0,0.2); }
.dark footer{ background:rgba(30,30,30,0.65); color:#fff; }

/* ================= FLEX ROW ================= */
.flexRow { display:flex; gap:10px; flex-wrap:wrap; }
.flexRow input, .flexRow select { flex:1; }
</style>
</head>

<body>
<div class="app" id="mainContainer">
  <!-- Dark Mode Toggle inside App Frame -->
  <div class="appHeader">
    <div class="toggleDark" id="darkToggle">üåô</div>
  </div>

  <h2>LeatherOn ‚Äì International Costing Calculator</h2>
  <div id="subscriptionUI"></div>

  <div id="mainApp" class="hidden">
    <div class="flexRow">
      <button onclick="openProductPopup()">‚ûï Add Product</button>
      <button onclick="resetAll()">üóë Reset All</button>
    </div>

    <input id="searchProd" placeholder="Search Products" oninput="filterProducts()">

    <div id="productList"></div>

    <div class="flexRow">
      <div style="flex:1"><h3>GST %</h3><input id="gst" type="number" value="18"></div>
      <div style="flex:1"><h3>Profit %</h3><input id="profit" type="number" value="20"></div>
    </div>

    <select id="currency"></select>

    <button onclick="calculateFinal()">Calculate Grand Total</button>
    <h2 id="grandTotal"></h2>

    <button onclick="exportTXT()">Export TXT</button>
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="generatePDFMenu()">Export PDF</button>
    <button onclick="showInvoiceHistory()">Invoice History</button>
  </div>
</div>

<footer>¬© <span id="year"></span> Manik Roy. All Rights Reserved.</footer>

<script>
/* ================= YEAR ================= */
document.getElementById("year").textContent = new Date().getFullYear();

/* ================= DEVICE LOCK ================= */
const deviceKey = "dev-"+btoa(navigator.userAgent + screen.width + screen.height);
if(localStorage.lc_device && localStorage.lc_device!==deviceKey){ alert("Locked to another device."); document.body.innerHTML="DEVICE LOCKED"; throw ""; }
else localStorage.lc_device=deviceKey;

/* ================= TRIAL + SUBSCRIPTION + ADMIN ================= */
let trialStart = localStorage.trialStart || (localStorage.trialStart = Date.now());
let trialDays = 7; // trial period
let subscriptionActive = localStorage.subActive === "yes";
const ADMIN_CODE = "MANIK-ADMIN-2026";
let paymentDone = localStorage.paymentDone === "yes";

function trialExpired(){ return (Date.now() - trialStart) > trialDays*86400000; }
function isLocked(){ return trialExpired() && !subscriptionActive; }

function requireAccess(actionName="this feature"){ 
  if(!isLocked()) return true; 
  alert("Trial expired. To access "+actionName+", activate subscription."); 
  openSubscriptionPopup(); return false; 
}

/* Subscription / Admin Popup */
function openSubscriptionPopup(){
  pop(`<h3>Subscription Required</h3>
  <p>Status: ${paymentDone?"Payment Done":"Payment Pending"}</p>
  <p>Plan: Monthly Subscription</p>
  <input id="adminInput" placeholder="Enter Admin Code">
  <button onclick="verifyAdmin()">Verify Admin & Activate</button>`);
}

function verifyAdmin(){
  const code = document.getElementById("adminInput").value.trim();
  if(code!==ADMIN_CODE){ alert("Invalid Admin Code"); return; }
  if(!paymentDone){ if(confirm("Admin verified. Confirm payment received?")){ paymentDone=true; localStorage.paymentDone="yes"; } }
  subscriptionActive=true; localStorage.subActive="yes";
  alert("Subscription Activated Successfully");
  closePop();
}

/* ================= POPUP ================= */
let popbox=null;
function pop(html){ if(popbox) popbox.remove(); let d=document.createElement("div"); d.className="popup"; d.innerHTML=html+`<br><button onclick='closePop()'>Close</button>`; document.body.appendChild(d); popbox=d; }
function closePop(){ if(popbox) popbox.remove(); }

/* ================= PRODUCTS ================= */
let products=[], filteredProducts=[];
function openProductPopup(){
  if(!requireAccess("Add Product")) return;

  let html=`<h3>Add Product</h3>
  <label>Product Type</label><select id='p_type'><option>Bag</option><option>Wallet</option><option>Belt</option><option>Shoe</option><option>Other</option></select>
  <label>Material</label><select id='p_material'><option>Full-Grain</option><option>Top-Grain</option><option>Bonded</option></select>
  <label>Grade</label><input id='p_grade'>
  <label>Thickness (mm)</label><input id='p_thick' type='number'>
  <label>Leather Area (sq.ft)</label><input id='p_area' type='number'>
  <label>Leather Rate</label><input id='p_rate' type='number'>
  <label>Quantity</label><input id='p_qty' type='number' value='1'>
  <label>Extra Expenses</label><input id='p_extra' type='number'>
  <label>Notes</label><textarea id='p_note'></textarea>
  <label>Product Image</label><input id='p_img' type='file' accept='image/*'>
  <img id='imgPrev' style='width:100%;display:none;border-radius:15px;margin-top:10px'>
  <button id='saveProdBtn'>Save Product</button>`;
  
  pop(html);

  const imgPrev=document.getElementById("imgPrev");
  document.getElementById("p_img").addEventListener("change",e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{ imgPrev.src=r.result; imgPrev.style.display="block"; }; r.readAsDataURL(f); });
  document.getElementById("saveProdBtn").addEventListener("click",saveProduct);
}

function val(id){ return document.getElementById(id).value; }
function num(id){ return Number(val(id))||0; }

function saveProduct(){
  const imgPrev=document.getElementById("imgPrev");
  const p={ type:val("p_type"), material:val("p_material"), grade:val("p_grade"),
            thick:num("p_thick"), area:num("p_area"), rate:num("p_rate"), qty:num("p_qty"),
            extra:num("p_extra"), note:val("p_note"), img:imgPrev.src||"" };
  p.total=(p.area*p.rate+p.extra)*p.qty;
  products.push(p);
  closePop();
  renderProducts();
}

function renderProducts(){ filteredProducts=products.slice(); updateProductList(); }
function updateProductList(){
  let box=document.getElementById("productList"); box.innerHTML="";
  filteredProducts.forEach((p,i)=>{
    box.innerHTML+=`<div class='prodCard'>
      <div class='prodTitle'>${p.type} (${p.material}) x${p.qty}</div>
      Area: ${p.area} | Rate: ${p.rate}<br>
      Total: $${p.total.toFixed(2)}<br>
      <button onclick='if(requireAccess("Delete Product")) delProd(${i})'>Delete</button>
      <button onclick='if(requireAccess("Duplicate Product")) cloneProd(${i})'>Duplicate</button>
    </div>`;
  });
}

function delProd(i){ products.splice(i,1); renderProducts(); }
function cloneProd(i){ products.push(JSON.parse(JSON.stringify(products[i]))); renderProducts(); }

function filterProducts(){ const q=document.getElementById("searchProd").value.toLowerCase(); filteredProducts=products.filter(p=>p.type.toLowerCase().includes(q)||p.material.toLowerCase().includes(q)); updateProductList(); }

function resetAll(){ if(!requireAccess("Reset All")) return; if(confirm("Clear all products and inputs?")){ products=[]; renderProducts(); document.getElementById("grandTotal").innerHTML=""; document.getElementById("gst").value=18; document.getElementById("profit").value=20; document.getElementById("currency").value="USD"; document.getElementById("searchProd").value=""; } }

/* ================= CALCULATION ================= */
function calculateFinal(){
  let sub=products.reduce((a,b)=>a+b.total,0);
  let g=num("gst"), pr=num("profit");
  let gstAmt=sub*(g/100), prAmt=sub*(pr/100), final=sub+gstAmt+prAmt;
  const c=document.getElementById("currency").value;
  const rates={USD:1,EUR:0.93,GBP:0.81,INR:82,AUD:1.55,CAD:1.36,SGD:1.36,JPY:150,AED:3.67};
  if(c!=="USD") final=(final*rates[c]).toFixed(2);
  document.getElementById("grandTotal").innerHTML=`Subtotal: $${sub.toFixed(2)}<br>GST (${g}%): $${gstAmt.toFixed(2)}<br>Profit (${pr}%): $${prAmt.toFixed(2)}<br><br><b>Grand Total: ${c} ${final}</b>`;
}

/* ================= EXPORTS ================= */
function exportTXT(){ let t="LEATHER COST REPORT\n\n"; products.forEach(p=>{ t+=`${p.type} x${p.qty} = $${p.total.toFixed(2)}\n`; }); saveFile(t,"report.txt"); }
function exportCSV(){ let c="Type,Material,Qty,Area,Rate,Total\n"; products.forEach(p=>{ c+=`${p.type},${p.material},${p.qty},${p.area},${p.rate},${p.total}\n`; }); saveFile(c,"report.csv"); }
function saveFile(txt,name){ let blob=new Blob([txt],{type:"text/plain"}); let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }

/* ================= INVOICES ================= */
function saveInv(name,amt){ let arr=JSON.parse(localStorage.getItem("lc_inv")||"[]"); arr.push({id:"INV"+Date.now(), date:new Date().toLocaleString(), name, amt}); localStorage.setItem("lc_inv",JSON.stringify(arr)); }
function showInvoiceHistory(){ let arr=JSON.parse(localStorage.getItem("lc_inv")||"[]"); let h="<h3>Invoice History</h3>"; arr.forEach(i=> h+=`<p>${i.id}<br>${i.date}<br>${i.name} - $${i.amt}</p><hr>`); pop(h); }

/* ================= CURRENCY ================= */
const currencySelect=document.getElementById("currency"); const currencies=["USD","EUR","GBP","INR","AUD","CAD","SGD","JPY","AED"]; currencies.forEach(c=>{ let o=document.createElement("option"); o.value=c; o.text=c; currencySelect.add(o); }); currencySelect.value="USD";

/* ================= DARK MODE ================= */
const darkToggle=document.getElementById("darkToggle"); darkToggle.addEventListener("click",()=>{ document.body.classList.toggle("dark"); darkToggle.textContent=document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô"; localStorage.lc_dark=document.body.classList.contains("dark")?"yes":"no"; });
if(localStorage.lc_dark==="yes"){ document.body.classList.add("dark"); darkToggle.textContent="‚òÄÔ∏è"; }

</script>
</body>
</html>
