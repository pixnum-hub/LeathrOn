<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LeathrOn - Leather Costing Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#e0e0e0;transition:0.3s;}
.dark{background:#1c1c1c;color:#fff;}
.app{position:relative;max-width:1000px;margin:30px auto;padding:25px;border-radius:30px;background:#e6e6e6;box-shadow:9px 9px 18px #b8b8b8,-9px -9px 18px #ffffff;}
.dark .app{background:#2a2a2a;box-shadow:9px 9px 18px #161616,-9px -9px 18px #3a3a3a;}
input,select,textarea{width:100%;padding:12px;border:none;margin:8px 0;border-radius:15px;background:#f2f2f2;box-shadow:inset 5px 5px 10px #bcbcbc,inset -5px -5px 10px #ffffff;outline:none;}
.dark input,.dark select,.dark textarea{background:#333;color:#fff;box-shadow:inset 5px 5px 10px #141414,inset -5px -5px 10px #474747;}
button{padding:14px 18px;border:none;border-radius:20px;margin:10px 0;background:#e6e6e6;box-shadow:6px 6px 12px #b8b8b8,-6px -6px 12px #ffffff;cursor:pointer;font-size:16px;width:100%;}
.dark button{background:#333;color:#fff;box-shadow:6px 6px 12px #141414,-6px -6px 12px #474747;}
.prodCard{padding:15px;border-radius:20px;background:#f3f3f3;margin:10px 0;box-shadow:inset 3px 3px 7px #bcbcbc,inset -3px -3px 7px #ffffff;}
.dark .prodCard{background:#333;box-shadow:inset 3px 3px 7px #141414,inset -3px -3px 7px #474747;}
.prodTitle{font-size:18px;font-weight:bold;margin:5px 0;}
.popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;color:#000;padding:25px;border-radius:22px;z-index:999999;width:90%;max-width:450px;max-height:85vh;overflow:auto;box-shadow:0 0 30px #0004;}
.dark .popup{background:#2e2e2e;color:#fff;}
footer{position:fixed;bottom:0;left:0;width:100%;text-align:center;padding:12px 0;font-size:14px;z-index:999;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:0.3s;background:rgba(224,224,224,0.65);color:#000;box-shadow:0 -3px 12px rgba(0,0,0,0.15),inset -3px -3px 8px rgba(255,255,255,0.7),inset 3px 3px 8px rgba(0,0,0,0.1);}
.dark footer{background:rgba(30,30,30,0.55);color:#fff;box-shadow:0 -3px 12px rgba(0,0,0,0.45),inset -3px -3px 8px rgba(80,80,80,0.2),inset 3px 3px 8px rgba(0,0,0,0.6);}
.toggleDark{position:absolute;top:15px;right:15px;width:50px;height:50px;border-radius:50%;background:#e6e6e6;cursor:grab;box-shadow:6px 6px 12px #b8b8b8,-6px -6px 12px #ffffff;display:flex;justify-content:center;align-items:center;font-size:22px;z-index:9999;transition:0.2s;}
.dark .toggleDark{background:#333;box-shadow:6px 6px 12px #141414,-6px -6px 12px #474747;}
.toggleDark:active{cursor:grabbing;transform:scale(1.1);}

/* Mobile responsiveness */
@media (max-width: 600px) {
  .app { max-width: 95%; margin:20px auto; padding:20px; border-radius:20px;}
  .toggleDark {width:45px; height:45px; font-size:20px;}
  input, select, textarea, button {font-size:15px; padding:10px;}
  #productList .prodCard {font-size:14px; padding:10px;}
}
</style>
</head>
<body>

<div class="app" id="mainContainer">
  <div class="toggleDark" id="darkToggle"><span id="darkIcon">üåô</span></div>

  <h2>LeathrOn</h2>
  <div id="subscriptionUI"></div>

  <div id="mainApp" class="hidden">
    <button onclick="openProductPopup()">‚ûï Add Product</button>
    <button onclick="resetAll()">üóë Reset All</button>
    <input id="searchProd" placeholder="Search Products" oninput="filterProducts()">
    <div id="productList"></div>

    <h3>GST %</h3><input id="gst" type="number" value="18">
    <h3>Profit %</h3><input id="profit" type="number" value="20">
    <select id="currency">
      <option value="INR">INR ‚Çπ</option>
      <option value="USD">USD $</option>
    </select>

    <button onclick="calculateFinal()">Calculate Grand Total</button>
    <h2 id="grandTotal"></h2>

    <button onclick="exportTXT()">Export TXT</button>
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="generatePDFMenu()">Export PDF</button>
    <button onclick="showInvoiceHistory()">Invoice History</button>
  </div>
</div>

<footer>¬© <span id="year"></span> Manik Roy. All Right Reserved.</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ====== AUTO YEAR ======
document.getElementById("year").textContent = new Date().getFullYear();

// ====== DARK MODE TOGGLE ======
const darkToggle=document.getElementById("darkToggle"),darkIcon=document.getElementById("darkIcon"),appContainer=document.getElementById("mainContainer");
let dragOffsetX=0, dragOffsetY=0, dragging=false, clickStartX=0, clickStartY=0, dragThreshold=5;
darkToggle.addEventListener("mousedown",startDrag);
darkToggle.addEventListener("touchstart",startDrag,{passive:false});
function startDrag(e){
 e.preventDefault();
 const rect=darkToggle.getBoundingClientRect();
 clickStartX=e.clientX||e.touches[0].clientX;
 clickStartY=e.clientY||e.touches[0].clientY;
 dragOffsetX=clickStartX-rect.left;
 dragOffsetY=clickStartY-rect.top;
 dragging=false;
 document.addEventListener("mousemove",dragMove);
 document.addEventListener("mouseup",endDrag);
 document.addEventListener("touchmove",dragMove,{passive:false});
 document.addEventListener("touchend",endDrag);
}
function dragMove(e){
 e.preventDefault();
 const clientX=e.clientX||e.touches[0].clientX;
 const clientY=e.clientY||e.touches[0].clientY;
 if(Math.abs(clientX-clickStartX)>dragThreshold||Math.abs(clientY-clickStartY)>dragThreshold) dragging=true;
 const rect=appContainer.getBoundingClientRect();
 let x=clientX-rect.left-dragOffsetX;
 let y=clientY-rect.top-dragOffsetY;
 x=Math.max(0,Math.min(rect.width-darkToggle.offsetWidth,x));
 y=Math.max(0,Math.min(rect.height-darkToggle.offsetHeight,y));
 darkToggle.style.left=x+"px";
 darkToggle.style.top=y+"px";
}
function endDrag(e){
 document.removeEventListener("mousemove",dragMove);
 document.removeEventListener("mouseup",endDrag);
 document.removeEventListener("touchmove",dragMove);
 document.removeEventListener("touchend",endDrag);
 if(!dragging) toggleDark();
}
function toggleDark(){
 document.body.classList.toggle("dark");
 darkIcon.textContent=document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
 localStorage.lc_dark=document.body.classList.contains("dark")?"yes":"no";
}
if(localStorage.lc_dark=="yes"){document.body.classList.add("dark");darkIcon.textContent="‚òÄÔ∏è";}

// ====== DEVICE LOCK, TRIAL & SUBSCRIPTION ======
const deviceKey="dev-"+btoa(navigator.userAgent+screen.width+screen.height);
if(localStorage.hip_device&&localStorage.hip_device!==deviceKey){alert("This app is locked to another PC.");document.body.innerHTML="DEVICE LOCKED";throw "";}else localStorage.hip_device=deviceKey;
if(!localStorage.hip_start){localStorage.hip_start=Date.now();}
const trialDays=30,ms=1000*60*60*24,passed=Math.floor((Date.now()-Number(localStorage.hip_start))/ms);
let subscribed=localStorage.hip_sub=="yes";
if(Date.now()<Number(localStorage.hip_start)){localStorage.hip_start=Date.now();}

function renderSubUI(){
 let el=document.getElementById("subscriptionUI");
 if(subscribed){document.getElementById("mainApp").classList.remove("hidden"); el.innerHTML="<p>Subscription Active ‚úì</p>"; return;}
 if(passed<=trialDays){
   el.innerHTML=`<p>Trial Remaining: ${trialDays-passed} days</p><button onclick="openPayment()">Buy ‚Çπ299/month</button>`;
   document.getElementById("mainApp").classList.remove("hidden");
 } else {
   el.innerHTML=`<p>Your trial has expired.</p>
   <button onclick="openPayment()">Buy ‚Çπ299/month</button><br><br>
   <input id="adminCode" placeholder="Admin Unlock Code"><button onclick="adminUnlock()">Unlock</button>`;
 }
}
renderSubUI();
function openPayment(){alert("Simulate UPI Payment here.");}
function adminUnlock(){let code=document.getElementById("adminCode").value.trim(); if(code=="MR-LX9Q-72KF-P8W3"){localStorage.hip_sub="yes";subscribed=true; renderSubUI();}else alert("Invalid code");}

// ====== PRODUCTS & CALCULATION ======
let products=[];
function openProductPopup(){
 popup(`<h3>Add Product</h3>
 <label>Product Name</label><input id="pName">
 <label>Leather Area (sq.ft)</label><input id="pArea" type="number">
 <label>Leather Rate</label><input id="pRate" type="number">
 <label>Other Expenses</label><input id="pExtra" type="number" value="0">
 <label>Currency</label><select id="pCcy"><option value="INR">INR ‚Çπ</option><option value="USD">USD $</option></select>
 <button onclick="addProduct()">Add</button>`);
}
function addProduct(){
 let name=document.getElementById("pName").value.trim();
 let area=Number(document.getElementById("pArea").value);
 let rate=Number(document.getElementById("pRate").value);
 let extra=Number(document.getElementById("pExtra").value);
 let ccy=document.getElementById("pCcy").value;
 if(!name||area<=0||rate<=0){alert("Enter valid details"); return;}
 products.push({name,area,rate,extra,ccy});
 closePopup();renderProducts();
}
function renderProducts(){
 let html="";
 products.forEach((p,i)=>{
   let total=p.area*p.rate+p.extra;
   if(p.ccy=="USD") total=(total/82).toFixed(2);
   html+=`<div class="prodCard"><div class="prodTitle">${p.name}</div>
   <p>Total: ${p.ccy=="INR"?"‚Çπ":"$"}${total}</p>
   <button onclick="removeProduct(${i})">Remove</button></div>`;
 });
 document.getElementById("productList").innerHTML=html;
}
function removeProduct(i){products.splice(i,1);renderProducts();}
function resetAll(){if(confirm("Clear all products and inputs?")){products=[];renderProducts();document.getElementById("grandTotal").textContent="";document.getElementById("gst").value=18;document.getElementById("profit").value=20;}}
function filterProducts(){let val=document.getElementById("searchProd").value.toLowerCase();document.querySelectorAll("#productList .prodCard").forEach((c,i)=>{c.style.display=products[i].name.toLowerCase().includes(val)?"block":"none";});}
function calculateFinal(){
 let gst=Number(document.getElementById("gst").value)/100,profit=Number(document.getElementById("profit").value)/100,ccy=document.getElementById("currency").value,total=0;
 products.forEach(p=>{let t=p.area*p.rate+p.extra;if(p.ccy=="USD") t/=82; total+=t;});
 total=total*(1+gst+profit);
 if(ccy=="USD") total=(total/82).toFixed(2); else total=total.toFixed(2);
 document.getElementById("grandTotal").textContent=(ccy=="INR"?"‚Çπ":"$")+total;
}

// ====== EXPORT TXT & CSV ======
function exportTXT(){let text="Leather Products:\n";products.forEach((p,i)=>{text+=`${i+1}. ${p.name} - ${p.area}sq.ft x ${p.rate} + ${p.extra} ${p.ccy}\n`;});let blob=new Blob([text],{type:"text/plain"});let a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="products.txt";a.click();}
function exportCSV(){let csv="Name,Area,Rate,Extra,Currency\n";products.forEach(p=>{csv+=`${p.name},${p.area},${p.rate},${p.extra},${p.ccy}\n`;});let blob=new Blob([csv],{type:"text/csv"});let a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="products.csv";a.click();}

// ====== PDF GENERATION ======
function generatePDFMenu(){
 const { jsPDF } = window.jspdf;
 let doc=new jsPDF();
 doc.setFontSize(16);
 doc.text("Leather Product Invoice",14,20);
 let y=30;
 products.forEach((p,i)=>{
   let total=p.area*p.rate+p.extra;
   if(p.ccy=="USD") total=(total/82).toFixed(2);
   doc.setFontSize(12);
   doc.text(`${i+1}. ${p.name} - ${p.area}sq.ft x ${p.rate} + ${p.extra} ${p.ccy} = ${total}`,14,y);
   y+=10;
   if(y>280){doc.addPage();y=20;}
 });
 let gst=Number(document.getElementById("gst").value),profit=Number(document.getElementById("profit").value),totalAmount=document.getElementById("grandTotal").textContent;
 doc.text(`GST: ${gst}%, Profit: ${profit}%`,14,y+10);
 doc.text(`Grand Total: ${totalAmount}`,14,y+20);
 doc.save("invoice.pdf");
}

// ====== POPUP SYSTEM ======
let currentPopup=null;
function popup(html){if(currentPopup) currentPopup.remove();let box=document.createElement("div");box.className="popup";box.innerHTML=html+`<br><br><button onclick="closePopup()">Close</button>`;document.body.appendChild(box);currentPopup=box;}
function closePopup(){if(currentPopup) currentPopup.remove();currentPopup=null;}

// ====== INVOICE HISTORY ======
function showInvoiceHistory(){
 let inv=JSON.parse(localStorage.getItem("hip_inv")||"[]");
 let html="<h2>Invoices</h2>";
 if(inv.length==0) html+="No invoices.";
 inv.forEach(i=>{html+=`<p><b>${i.id}</b><br>${i.date}<br>‚Çπ${i.amount}</p><hr>`;});
 popup(html);
}
</script>
</body>
</html>
