<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeathrOn - Leather Costing Calculator</title>
<style>
/* ========== GLOBAL MOBILE-FIRST STYLING ========== */
html, body {
  margin:0;
  padding:0;
  font-family:Arial, sans-serif;
  background:#e0e0e0;
  transition:0.3s;
  font-size:18px;
}
.dark { background:#1c1c1c; color:#fff; }

/* MAIN APP CONTAINER */
.app {
  position:relative;
  width:100%;
  max-width:720px;
  margin:0 auto;
  padding:20px;
  border-radius:25px;
  background:#e6e6e6;
  box-shadow:8px 8px 16px #b8b8b8, -8px -8px 16px #ffffff;
}
.dark .app {
  background:#2a2a2a;
  box-shadow:8px 8px 16px #161616, -8px -8px 16px #3a3a3a;
}

/* INPUTS */
input, select, textarea {
  width:100%;
  padding:14px;
  font-size:18px;
  border:none;
  margin:10px 0;
  border-radius:15px;
  background:#f2f2f2;
  box-shadow:inset 4px 4px 8px #bcbcbc, inset -4px -4px 8px #ffffff;
  outline:none;
}
.dark input, .dark select, .dark textarea {
  background:#333;
  color:#fff;
  box-shadow:inset 4px 4px 8px #141414, inset -4px -4px 8px #474747;
}

/* BUTTONS */
button {
  padding:16px;
  border:none;
  border-radius:18px;
  margin:12px 0;
  width:100%;
  font-size:18px;
  cursor:pointer;
  background:#e6e6e6;
  box-shadow:6px 6px 12px #b8b8b8, -6px -6px 12px #ffffff;
}
.dark button {
  background:#333;
  color:#fff;
  box-shadow:6px 6px 12px #141414, -6px -6px 12px #474747;
}

/* PRODUCT CARDS */
.prodCard {
  padding:15px;
  border-radius:18px;
  background:#f3f3f3;
  margin:12px 0;
  font-size:18px;
  box-shadow:inset 3px 3px 7px #bcbcbc, inset -3px -3px 7px #ffffff;
}
.dark .prodCard {
  background:#333;
  box-shadow:inset 3px 3px 7px #141414, inset -3px -3px 7px #474747;
}
.prodTitle { font-size:20px; font-weight:bold; margin-bottom:8px; }

/* POPUP */
.popup {
  position:fixed;
  top:50%; left:50%; transform:translate(-50%, -50%);
  width:90vw;
  max-width:450px;
  max-height:85vh;
  overflow-y:auto;
  background:#fff;
  color:#000;
  padding:20px;
  border-radius:20px;
  box-shadow:0 0 30px #0005;
  z-index:999999;
}
.dark .popup { background:#2e2e2e; color:#fff; }

/* FOOTER */
footer {
  position:fixed;
  bottom:0; left:0;
  width:100%;
  padding:14px 0;
  text-align:center;
  background:rgba(224,224,224,0.7);
  font-size:16px;
  backdrop-filter:blur(10px);
  box-shadow:0 -3px 12px rgba(0,0,0,0.2);
}
.dark footer {
  background:rgba(30,30,30,0.65);
  color:#fff;
}

/* DARK MODE TOGGLE ‚Äì MOBILE FRIENDLY */
.toggleDark {
  position:absolute;
  top:10px; right:10px;
  width:60px; height:60px;
  border-radius:50%;
  background:#e6e6e6;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  cursor:grab;
  box-shadow:6px 6px 12px #b8b8b8, -6px -6px 12px #ffffff;
  z-index:9999;
  transition:0.2s;
}
.dark .toggleDark {
  background:#333;
  box-shadow:6px 6px 12px #141414, -6px -6px 12px #474747;
}
.toggleDark:active { transform:scale(1.1); cursor:grabbing; }
</style>
</head>
<body>

<div class="app" id="mainContainer">
  <div class="toggleDark" id="darkToggle"><span id="darkIcon">üåô</span></div>

  <h2>LeathrOn</h2>
  <div id="subscriptionUI"></div>

  <div id="mainApp" class="hidden">
    <button onclick="openProductPopup()">‚ûï Add Product</button>
    <button onclick="resetAll()">üóë Reset All</button>
    <input id="searchProd" placeholder="Search Products" oninput="filterProducts()">
    <div id="productList"></div>

    <h3>GST %</h3><input id="gst" type="number" value="18">
    <h3>Profit %</h3><input id="profit" type="number" value="20">

    <select id="currency">
      <option value="INR">INR ‚Çπ</option>
      <option value="USD">USD $</option>
    </select>

    <button onclick="calculateFinal()">Calculate Grand Total</button>
    <h2 id="grandTotal"></h2>

    <button onclick="exportTXT()">Export TXT</button>
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="generatePDFMenu()">Export PDF</button>
    <button onclick="showInvoiceHistory()">Invoice History</button>
  </div>
</div>

<footer>¬© <span id="year"></span> Manik Roy. All Right Reserved.</footer>

<script>
/* Year Update */
document.getElementById("year").textContent = new Date().getFullYear();

/* ------------------------- DEVICE LOCK ------------------------- */
const deviceKey = "dev-" + btoa(navigator.userAgent + screen.width + screen.height);
if (localStorage.lc_device && localStorage.lc_device !== deviceKey) {
  alert("Locked to another device.");
  document.body.innerHTML = "DEVICE LOCKED";
  throw "";
} else {
  localStorage.lc_device = deviceKey;
}

/* --------------------- TRIAL & SUBSCRIPTION --------------------- */
if (!localStorage.lc_start) localStorage.lc_start = Date.now();
let subscribed = localStorage.lc_sub === "yes";

function renderSub() {
  let rem = Math.floor((30*86400000 - (Date.now() - localStorage.lc_start)) / 86400000);
  const box = document.getElementById("subscriptionUI");

  if (subscribed) {
    document.getElementById("mainApp").classList.remove("hidden");
    box.innerHTML = "Subscription Active ‚úì";
    return;
  }

  if (Date.now() - localStorage.lc_start < 30*86400000) {
    box.innerHTML = `Trial: ${rem} days left<br><button onclick="pay()">Buy ‚Çπ299/month</button>`;
    document.getElementById("mainApp").classList.remove("hidden");
  } else {
    box.innerHTML = `Trial expired<br><button onclick="pay()">Buy ‚Çπ299/month</button><br><input id='adm' placeholder='Admin Code'><button onclick='admUnlock()'>Unlock</button>`;
  }
}
renderSub();

function pay() {
  let upi = "upi://pay?pa=9433082017@ybl&pn=Manik%20Roy&am=299&cu=INR";
  let qr = "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(upi);
  pop(`<h3>Pay ‚Çπ299</h3><img src='${qr}' style='width:200px;'><br>UPI: 9433082017@ybl<button onclick='activateSub()'>I Paid</button>`);
}
function activateSub() {
  localStorage.lc_sub = "yes";
  subscribed = true;
  closePop();
  renderSub();
}
function admUnlock() {
  if (document.getElementById("adm").value === "MR-LX9Q-72KF-P8W3") {
    localStorage.lc_sub = "yes";
    subscribed = true;
    renderSub();
  } else alert("Invalid Code");
}

/* ---------------------------- POPUP ---------------------------- */
let popbox = null;
function pop(html) {
  if (popbox) popbox.remove();
  let d = document.createElement("div");
  d.className = "popup";
  d.innerHTML = html + `<br><button onclick='closePop()'>Close</button>`;
  document.body.appendChild(d);
  popbox = d;
}
function closePop() { if (popbox) popbox.remove(); }

/* -------------------------- PRODUCT LOGIC -------------------------- */
let products = [];
let filteredProducts = [];

function openProductPopup() {
  let html = `
  <h3>Add Product</h3>
  <label>Product Type</label><select id='p_type'><option>Bag</option><option>Wallet</option><option>Belt</option><option>Shoe</option><option>Other</option></select>
  <label>Material</label><select id='p_material'><option>Full-Grain</option><option>Top-Grain</option><option>Bonded</option></select>
  <label>Grade</label><input id='p_grade'>
  <label>Thickness (mm)</label><input id='p_thick' type='number'>
  <label>Leather Area (sq.ft)</label><input id='p_area' type='number'>
  <label>Leather Rate</label><input id='p_rate' type='number'>
  <label>Quantity</label><input id='p_qty' type='number' value='1'>
  <label>Extra Expenses</label><input id='p_extra' type='number'>
  <label>Notes</label><textarea id='p_note'></textarea>
  <label>Product Image</label><input id='p_img' type='file' accept='image/*'>
  <img id='imgPrev' style='width:100%;display:none;border-radius:15px;margin-top:10px;'>
  <button id='saveProdBtn'>Save Product</button>`;

  pop(html);

  const imgPrev = document.getElementById("imgPrev");
  document.getElementById("p_img").addEventListener("change", e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      imgPrev.src = r.result;
      imgPrev.style.display = "block";
    };
    r.readAsDataURL(f);
  });

  document.getElementById("saveProdBtn").addEventListener("click", saveProduct);
}

function saveProduct() {
  const imgPrev = document.getElementById("imgPrev");
  const p = {
    type: val("p_type"), material: val("p_material"), grade: val("p_grade"),
    thick: num("p_thick"), area: num("p_area"), rate: num("p_rate"), qty: num("p_qty"),
    extra: num("p_extra"), note: val("p_note"), img: imgPrev.src || ""
  };
  p.total = (p.area * p.rate + p.extra) * p.qty;
  products.push(p);
  closePop();
  renderProducts();
}

function val(id){ return document.getElementById(id).value; }
function num(id){ return Number(val(id))||0; }

function renderProducts() {
  filteredProducts = products.slice();
  updateProductList();
}
function updateProductList() {
  let box = document.getElementById("productList");
  box.innerHTML = "";
  filteredProducts.forEach((p,i)=>{
    box.innerHTML += `
    <div class='prodCard'>
      <div class='prodTitle'>${p.type} (${p.material}) x${p.qty}</div>
      Area: ${p.area} | Rate: ${p.rate}<br>
      Total: ‚Çπ${p.total.toFixed(2)}<br>
      <button onclick='delProd(${i})'>Delete</button>
      <button onclick='cloneProd(${i})'>Duplicate</button>
    </div>`;
  });
}

function delProd(i){ products.splice(i,1); renderProducts(); }
function cloneProd(i){ products.push(JSON.parse(JSON.stringify(products[i]))); renderProducts(); }

function filterProducts(){
  const q = document.getElementById("searchProd").value.toLowerCase();
  filteredProducts = products.filter(p => p.type.toLowerCase().includes(q) || p.material.toLowerCase().includes(q));
  updateProductList();
}

function resetAll(){
  if(confirm("Clear all products and inputs?")){
    products = [];
    renderProducts();
    document.getElementById("grandTotal").innerHTML = "";
    document.getElementById("gst").value = 18;
    document.getElementById("profit").value = 20;
    document.getElementById("currency").value = "INR";
    document.getElementById("searchProd").value = "";
  }
}

/* --------------------------- CALCULATION --------------------------- */
function calculateFinal() {
  let sub = products.reduce((a,b)=>a+b.total,0);
  let g = num("gst"), pr = num("profit");
  let gstAmt = sub*(g/100);
  let prAmt = sub*(pr/100);
  let final = sub + gstAmt + prAmt;

  const c = document.getElementById("currency").value;
  if(c=="USD") final = (final/82).toFixed(2);

  document.getElementById("grandTotal").innerHTML = `
  Subtotal: ‚Çπ${sub.toFixed(2)}<br>
  GST (${g}%): ‚Çπ${gstAmt.toFixed(2)}<br>
  Profit (${pr}%): ‚Çπ${prAmt.toFixed(2)}<br><br>
  <b>Grand Total: ${c=="INR"?"‚Çπ":"$"}${final}</b>`;
}

/* ----------------------------- EXPORTS ----------------------------- */
function exportTXT() {
  let t = "LEATHER COST REPORT\n\n";
  products.forEach(p=>{ t += `${p.type} x${p.qty} = ‚Çπ${p.total.toFixed(2)}\n`; });
  saveFile(t,"report.txt");
}
function exportCSV() {
  let c = "Type,Material,Qty,Area,Rate,Total\n";
  products.forEach(p=>{ c += `${p.type},${p.material},${p.qty},${p.area},${p.rate},${p.total}\n`; });
  saveFile(c,"report.csv");
}
function saveFile(txt,name) {
  let blob = new Blob([txt],{type:"text/plain"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

/* ----------------------------- INVOICES ----------------------------- */
function saveInv(name,amt){
  let arr = JSON.parse(localStorage.getItem("lc_inv")||"[]");
  arr.push({ id:"INV"+Date.now(), date:new Date().toLocaleString(), name, amt });
  localStorage.setItem("lc_inv", JSON.stringify(arr));
}
function showInvoiceHistory(){
  let arr = JSON.parse(localStorage.getItem("lc_inv")||"[]");
  let h = "<h3>Invoice History</h3>";
  arr.forEach(i=> h += `<p>${i.id}<br>${i.date}<br>${i.name} - ‚Çπ${i.amt}</p><hr>`);
  pop(h);
}

/* ----------------------------- DARK MODE ----------------------------- */
const darkToggle = document.getElementById("darkToggle");
const appContainer = document.getElementById("mainContainer");
let dragging=false, offsetX=0, offsetY=0, clickStartX=0, clickStartY=0, dragThreshold=5;

darkToggle.addEventListener("mousedown", startDrag);
darkToggle.addEventListener("touchstart", startDrag, {passive:false});

function startDrag(e) {
  e.preventDefault();
  const rect = darkToggle.getBoundingClientRect();
  const clientX = e.touches? e.touches[0].clientX : e.clientX;
  const clientY = e.touches? e.touches[0].clientY : e.clientY;

  offsetX = clientX - rect.left;
  offsetY = clientY - rect.top;
  clickStartX = clientX;
  clickStartY = clientY;

  dragging = false;

  document.addEventListener("mousemove", dragToggle);
  document.addEventListener("mouseup", endDrag);
  document.addEventListener("touchmove", dragToggle, {passive:false});
  document.addEventListener("touchend", endDrag);
}

function dragToggle(e) {
  e.preventDefault();
  const clientX = e.touches? e.touches[0].clientX : e.clientX;
  const clientY = e.touches? e.touches[0].clientY : e.clientY;

  if (Math.abs(clientX-clickStartX)>dragThreshold || Math.abs(clientY-clickStartY)>dragThreshold) dragging = true;

  let x = clientX - offsetX;
  let y = clientY - offsetY;

  x = Math.max(0, Math.min(window.innerWidth - darkToggle.offsetWidth, x));
  y = Math.max(0, Math.min(window.innerHeight - darkToggle.offsetHeight, y));

  darkToggle.style.left = x + "px";
  darkToggle.style.top = y + "px";
}

function endDrag(e){
  document.removeEventListener("mousemove", dragToggle);
  document.removeEventListener("mouseup", endDrag);
  document.removeEventListener("touchmove", dragToggle);
  document.removeEventListener("touchend", endDrag);

  if (!dragging) toggleDarkMode();
}

function toggleDarkMode(){
  document.body.classList.toggle("dark");
  document.getElementById("darkIcon").textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.lc_dark = document.body.classList.contains("dark") ? "yes" : "no";
}

if(localStorage.lc_dark==="yes"){
  document.body.classList.add("dark");
  document.getElementById("darkIcon").textContent = "‚òÄÔ∏è";
}
</script>

</body></html>